<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de pactos 21D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Public Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #ffffff;
      --primary-text: #222;
      --muted: #f2f2f2;
      --border: #dddddd;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--primary-text);
    }

    .pactometro-widget {
      max-width: 1100px;
      margin: 0 auto;
      border: 1px solid var(--border);
      padding: 12px;
      background: #fff;
      font-size: 14px;
    }

    /* Cabecera con título + última actualización */
    .pacto-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .pacto-header {
      font-weight: 600;
    }

    .pacto-last-update {
      font-size: 11px;
      color: #666666;
    }

    .pacto-layout {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .pacto-left {
      flex: 1 1 260px;
      min-width: 260px;
    }

    .pacto-right {
      flex: 2 1 320px;
      min-width: 320px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 4px 6px;
      text-align: left;
    }

    thead th {
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 12px;
    }

    tbody tr:nth-child(odd) {
      background: #fafafa;
    }

    .party-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      color: #fff;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .pacto-main-bar {
      margin-bottom: 8px;
    }

    .pacto-main-bar-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .bar-track {
      position: relative;
      height: 20px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
    }

    #bar-segments {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      z-index: 1;
    }

    .bar-segment {
      position: absolute;
      top: 0;
      height: 100%;
    }

    .bar-tooltip {
      position: absolute;
      padding: 4px 6px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      font-size: 11px;
      border-radius: 3px;
      pointer-events: none;
      white-space: nowrap;
      transform: translate(-50%, -120%);
      display: none;
      z-index: 3;
    }

    .majority-marker {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #000;
      z-index: 2;
    }

    .majority-text {
      position: absolute;
      top: 22px;
      transform: translateX(-50%);
      font-size: 11px;
      white-space: nowrap;
      z-index: 2;
    }

    .pacto-summary {
      margin: 16px 0 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .pacto-parties-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      font-size: 13px;
    }

    .party-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      background: #f7f7f7;
      border-radius: 4px;
    }

    .party-item-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .party-checkbox {
      margin-right: 4px;
    }

    .buttons-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .btn-base {
      font-size: 13px;
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .reset-btn {
      background: #000000;
      color: #ffffff;
    }

    .reset-btn:hover {
      background: #222222;
    }

    .reset-btn:active {
      transform: translateY(1px);
    }

    .reload-btn {
      background: #ffffff;
      color: #000000;
      border: 1px solid #000000;
    }

    .reload-btn:hover {
      background: #f2f2f2;
    }

    .reload-btn:active {
      transform: translateY(1px);
    }

    @media (max-width: 600px) {
      .pactometro-widget {
        padding: 8px;
      }

      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="pactometro-widget" data-total-seats="65">
    <div class="pacto-header-row">
      <div class="pacto-header">Calculadora de pactos 21D</div>
      <div class="pacto-last-update" id="pacto-last-update"></div>
    </div>

    <div class="pacto-layout">
      <!-- IZQUIERDA: TABLA -->
      <div class="pacto-left">
        <table>
          <thead>
            <tr>
              <th>Partido</th>
              <th>Escaños 2023</th>
              <th>Escaños 2025</th>
              <th>Dif.</th>
            </tr>
          </thead>
          <tbody id="party-table-body"></tbody>
        </table>
      </div>

      <!-- DERECHA: BARRA + CONFIGURADOR -->
      <div class="pacto-right">
        <div class="pacto-main-bar">
          <div class="pacto-main-bar-labels">
            <span>
              Total escaños:
              <span id="total-seats-selected">0</span> /
              <span id="total-seats-max">65</span>
            </span>
            <span>
              Mayoría absoluta:
              <span id="majority-number">33</span> escaños
            </span>
          </div>

          <div class="bar-track">
            <div id="bar-segments"></div>
            <div class="bar-tooltip" id="bar-tooltip"></div>
            <div class="majority-marker" id="majority-marker"></div>
            <div class="majority-text" id="majority-text"></div>
          </div>
        </div>

        <div class="pacto-summary" id="pacto-summary">
          Selecciona partidos para formar una mayoría.
        </div>

        <div class="buttons-row">
          <button type="button" class="btn-base reset-btn" id="reset-btn">
            Volver a empezar
          </button>
          <button type="button" class="btn-base reload-btn" id="reload-btn">
            Actualizar datos
          </button>
        </div>

        <div class="pacto-parties-list" id="pacto-parties-list"></div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', function () {
      // ===== CONFIG SUPABASE =====
      const SUPABASE_URL = 'https://xllvmudwstmeqvpcbzhs.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsbHZtdWR3c3RtZXF2cGNiemhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2Nzc2NjEsImV4cCI6MjA4MDI1MzY2MX0.cxLTnkEYd8Vj34ISZcQvs_CdRjNE3x4eLl7t9NY_13A';

      // Datos en memoria
      const data = {
        totalSeats: 65,
        parties: []
      };

      // Colores por partido
      const COLOR_MAP = {
        pp: '#0070c0',
        psoe: '#e31837',
        vox: '#53a318',
        podemosiuav: '#8c2c8d'
      };

      // ===== DOM REFS =====
      const totalSeatsMaxEl      = document.getElementById('total-seats-max');
      const totalSeatsSelectedEl = document.getElementById('total-seats-selected');
      const majorityNumberEl     = document.getElementById('majority-number');
      const majorityMarkerEl     = document.getElementById('majority-marker');
      const majorityTextEl       = document.getElementById('majority-text');
      const pactoSummaryEl       = document.getElementById('pacto-summary');
      const partyTableBodyEl     = document.getElementById('party-table-body');
      const partyListEl          = document.getElementById('pacto-parties-list');
      const barSegmentsEl        = document.getElementById('bar-segments');
      const barTooltipEl         = document.getElementById('bar-tooltip');
      const resetBtnEl           = document.getElementById('reset-btn');
      const reloadBtnEl          = document.getElementById('reload-btn');
      const lastUpdateEl         = document.getElementById('pacto-last-update');

      if (!partyTableBodyEl || !partyListEl) {
        console.error('No se han encontrado los contenedores principales del pactómetro');
        return;
      }

      const majority = Math.floor(data.totalSeats / 2) + 1; // 33 para 65

      totalSeatsMaxEl.textContent  = data.totalSeats;
      majorityNumberEl.textContent = majority;

      const majorityPercent = (majority / data.totalSeats) * 100;
      if (majorityMarkerEl && majorityTextEl) {
        majorityMarkerEl.style.left = majorityPercent + '%';
        majorityTextEl.style.left   = majorityPercent + '%';
        majorityTextEl.textContent  = 'Mayoría: ' + majority;
      }

      // ===== FUNCIONES AUXILIARES =====

      async function loadRowsFromSupabase() {
        try {
          const res = await fetch(
            SUPABASE_URL + '/rest/v1/pactometro_results?select=*&order=seats_2025.desc',
            {
              headers: {
                apikey: SUPABASE_ANON_KEY,
                Authorization: 'Bearer ' + SUPABASE_ANON_KEY
              }
            }
          );

          if (!res.ok) {
            console.error('Error al cargar datos de Supabase', await res.text());
            return [];
          }

          return await res.json();
        } catch (err) {
          console.error('Error de red cargando Supabase', err);
          return [];
        }
      }

      function updateLastUpdateLabel(rows) {
        if (!lastUpdateEl || !Array.isArray(rows) || rows.length === 0) return;

        const fechas = rows
          .map(r => r.updated_at)
          .filter(Boolean)
          .map(d => new Date(d));

        if (fechas.length === 0) return;

        const maxDate = new Date(Math.max(...fechas));
        const texto = maxDate.toLocaleString('es-ES', {
          timeZone: 'Europe/Madrid',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        lastUpdateEl.textContent = 'Última actualización: ' + texto;
      }

      function buildDataFromRows(rows) {
        data.parties = (rows || []).map(row => ({
          id: row.party_id,
          name: row.party_name,
          color: COLOR_MAP[row.party_id] || '#888888',
          seats2023: row.seats_2023 ?? 0,
          seats2025: row.seats_2025 ?? 0,
          vote2025: row.vote_pct_2025 != null ? Number(row.vote_pct_2025) : null
        }));

        // Diferencia de escaños
        data.parties.forEach(p => {
          p.diffSeats = p.seats2025 - p.seats2023;
        });

        // Ordenar por escaños 2025 (descendente)
        data.parties.sort((a, b) => b.seats2025 - a.seats2025);
      }

      // ===== RENDER TABLA IZQUIERDA =====
      function renderTable() {
        partyTableBodyEl.innerHTML = '';

        const partiesWithSeats = data.parties.filter(p => p.seats2025 >= 1);

        partiesWithSeats.forEach(p => {
          const row = document.createElement('tr');
          const diff =
            p.diffSeats > 0
              ? '▲ ' + p.diffSeats
              : p.diffSeats < 0
                ? '▼ ' + Math.abs(p.diffSeats)
                : '–';

          row.innerHTML = `
            <td>
              <div class="party-label" style="background:${p.color}">
                <span>${p.name}</span>
              </div>
            </td>
            <td>${p.seats2023}</td>
            <td>${p.seats2025}</td>
            <td>${diff}</td>
          `;
          partyTableBodyEl.appendChild(row);
        });
      }

      // ===== RENDER LISTA DE PARTIDOS (CHECKBOXES) =====
      function renderPartyList(selectedIds = []) {
        partyListEl.innerHTML = '';

        const selectableParties = data.parties.filter(p => p.seats2025 >= 1);

        selectableParties.forEach(p => {
          const item = document.createElement('div');
          item.className = 'party-item';
          item.innerHTML = `
            <div class="party-item-left">
              <input type="checkbox"
                     class="party-checkbox"
                     data-party-id="${p.id}">
              <span style="width:10px;height:10px;border-radius:2px;background:${p.color};display:inline-block;"></span>
              <span>${p.name}</span>
            </div>
            <div>
              <span>${p.seats2025} escaños</span>
            </div>
          `;

          const checkbox = item.querySelector('.party-checkbox');
          if (selectedIds.includes(p.id)) {
            checkbox.checked = true;
          }

          checkbox.addEventListener('change', updateTotals);
          partyListEl.appendChild(item);
        });
      }

      // ===== TOOLTIP BARRA =====
      function showTooltip(evt, party) {
        if (!barTooltipEl) return;
        const rect = barSegmentsEl.getBoundingClientRect();
        const x = evt.clientX - rect.left;

        barTooltipEl.style.left = x + 'px';
        barTooltipEl.style.top  = rect.height + 'px';

        let voteText = 'sin dato';
        if (typeof party.vote2025 === 'number') {
          voteText = party.vote2025.toFixed(1) + '%';
        }

        barTooltipEl.textContent = `${party.name} · ${voteText} · ${party.seats2025} escaños`;
        barTooltipEl.style.display = 'block';
      }

      function hideTooltip() {
        if (!barTooltipEl) return;
        barTooltipEl.style.display = 'none';
      }

      // ===== COMUNICAR ALTURA AL PADRE (AUTO-RESIZE IFRAME) =====
      function sendHeightToParent() {
        const height = document.documentElement.scrollHeight;
        window.parent.postMessage(
          { type: 'pactometro-resize', height },
          '*'
        );
      }

      // ===== ACTUALIZAR TOTALES Y BARRA =====
      function updateTotals() {
        let total = 0;
        const selectedParties = [];

        document.querySelectorAll('.party-checkbox:checked').forEach(chk => {
          const id = chk.getAttribute('data-party-id');
          const party = data.parties.find(p => p.id === id);
          if (party) {
            total += party.seats2025;
            selectedParties.push(party);
          }
        });

        totalSeatsSelectedEl.textContent = total;
        barSegmentsEl.innerHTML = '';

        selectedParties.sort((a, b) => b.seats2025 - a.seats2025);

        let acumulado = 0;
        selectedParties.forEach(p => {
          const widthPercent = (p.seats2025 / data.totalSeats) * 100;
          const leftPercent  = (acumulado / data.totalSeats) * 100;

          const seg = document.createElement('div');
          seg.className = 'bar-segment';
          seg.style.left = leftPercent + '%';
          seg.style.width = widthPercent + '%';
          seg.style.background = p.color;

          seg.addEventListener('mousemove', evt => showTooltip(evt, p));
          seg.addEventListener('mouseenter', evt => showTooltip(evt, p));
          seg.addEventListener('mouseleave', hideTooltip);

          barSegmentsEl.appendChild(seg);
          acumulado += p.seats2025;
        });

        if (total === 0) {
          pactoSummaryEl.textContent = 'Selecciona partidos para formar una mayoría.';
        } else if (total >= majority) {
          pactoSummaryEl.textContent =
            '✅ Mayoría alcanzada (' + total + ' escaños) con: ' +
            selectedParties.map(p => p.name).join(', ') + '.';
        } else {
          const diff = majority - total;
          pactoSummaryEl.textContent =
            '❌ No hay mayoría (' + total + ' escaños). Faltan ' + diff + ' escaños.';
        }

        sendHeightToParent();
      }

      // ===== RESET =====
      function resetSelection() {
        document.querySelectorAll('.party-checkbox').forEach(chk => {
          chk.checked = false;
        });
        hideTooltip();
        updateTotals();
      }

      if (resetBtnEl) {
        resetBtnEl.addEventListener('click', resetSelection);
      }

      // ===== REFRESCAR DATOS (botón y auto) =====
      async function refreshData(options = {}) {
        const keepSelection = options.keepSelection !== false;

        let selectedIds = [];
        if (keepSelection) {
          document.querySelectorAll('.party-checkbox:checked').forEach(chk => {
            selectedIds.push(chk.getAttribute('data-party-id'));
          });
        }

        const rows = await loadRowsFromSupabase();
        buildDataFromRows(rows);
        updateLastUpdateLabel(rows);
        renderTable();
        renderPartyList(selectedIds);
        updateTotals();
      }

      if (reloadBtnEl) {
        reloadBtnEl.addEventListener('click', () => {
          refreshData().catch(err => console.error('Error al refrescar datos', err));
        });
      }

      // ===== INICIO =====
      refreshData({ keepSelection: false }).catch(err =>
        console.error('Error inicial cargando datos', err)
      );

      window.addEventListener('load', sendHeightToParent);
      window.addEventListener('resize', () => {
        clearTimeout(window.__pactoResizeTimeout);
        window.__pactoResizeTimeout = setTimeout(sendHeightToParent, 150);
      });

      // Auto-refresh cada 60 segundos
      setInterval(() => {
        refreshData().catch(err => console.error('Error en auto-refresh', err));
      }, 60000);
    });
  </script>
</body>
</html>









