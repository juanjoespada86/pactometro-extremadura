<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de pactos 21D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Public Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --primary-text: #222;
      --muted: #f2f2f2;
      --border: #dddddd;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--primary-text);
    }

    .pactometro-widget {
      max-width: 1100px;
      margin: 0 auto;
      border: 1px solid var(--border);
      padding: 12px;
      background: #fff;
      font-size: 14px;
    }

    .pacto-top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .pacto-header {
      font-weight: 600;
    }

    .pacto-layout {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .pacto-left {
      flex: 1 1 260px;
      min-width: 260px;
    }

    .pacto-right {
      flex: 2 1 320px;
      min-width: 320px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 4px 6px;
      text-align: left;
    }

    thead th {
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 12px;
    }

    tbody tr:nth-child(odd) {
      background: #fafafa;
    }

    .party-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      color: #fff;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .pacto-main-bar {
      margin-bottom: 8px;
    }

    .pacto-main-bar-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .bar-track {
      position: relative;
      height: 20px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
    }

    #bar-segments {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      z-index: 1;
    }

    .bar-segment {
      position: absolute;
      top: 0;
      height: 100%;
    }

    .bar-tooltip {
      position: absolute;
      padding: 4px 6px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      font-size: 11px;
      border-radius: 3px;
      pointer-events: none;
      white-space: nowrap;
      transform: translate(-50%, -120%);
      display: none;
      z-index: 3;
    }

    .majority-marker {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #000;
      z-index: 2;
    }

    .majority-text {
      position: absolute;
      top: 22px;
      transform: translateX(-50%);
      font-size: 11px;
      white-space: nowrap;
      z-index: 2;
    }

    .pacto-summary {
      margin: 8px 0;
      font-size: 14px;
      font-weight: 500;
    }

    .pacto-parties-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      font-size: 13px;
    }

    .party-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      background: #f7f7f7;
      border-radius: 4px;
    }

    .party-item-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .party-checkbox {
      margin-right: 4px;
    }

    .reset-btn {
      margin-bottom: 8px;
      font-size: 13px;
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: #000000;
      color: #ffffff;
      cursor: pointer;
      font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .reset-btn:hover {
      background: #222222;
    }

    .reset-btn:active {
      transform: translateY(1px);
    }

    .pacto-meta {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #555;
      flex-wrap: wrap;
      text-align: right;
    }

    .refresh-btn {
      font-size: 13px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid #000;
      background: #ffffff;
      color: #000000;
      cursor: pointer;
      font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .refresh-btn:hover {
      background: #f0f0f0;
    }

    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    @media (max-width: 600px) {
      .pactometro-widget {
        padding: 8px;
      }

      table {
        font-size: 12px;
      }

      .pacto-top-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .pacto-meta {
        justify-content: flex-start;
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="pactometro-widget" data-total-seats="65">
    <!-- BARRA SUPERIOR: TÍTULO + META (ARRIBA A LA DERECHA) -->
    <div class="pacto-top-bar">
      <div class="pacto-header">Calculadora de pactos 21D</div>
      <div class="pacto-meta">
        <span id="last-update-label">Última actualización: —</span>
        <button type="button" class="refresh-btn" id="refresh-btn">
          Actualizar datos
        </button>
      </div>
    </div>

    <div class="pacto-layout">
      <!-- IZQUIERDA: TABLA -->
      <div class="pacto-left">
        <table>
          <thead>
            <tr>
              <th>Partido</th>
              <th>Escaños 2023</th>
              <th>Escaños 2025</th>
              <th>Dif.</th>
            </tr>
          </thead>
          <tbody id="party-table-body"></tbody>
        </table>
      </div>

      <!-- DERECHA: BARRA + CONFIGURADOR -->
      <div class="pacto-right">
        <div class="pacto-main-bar">
          <div class="pacto-main-bar-labels">
            <span>
              Total escaños:
              <span id="total-seats-selected">0</span> /
              <span id="total-seats-max">65</span>
            </span>
            <span>
              Mayoría absoluta:
              <span id="majority-number">33</span> escaños
            </span>
          </div>

          <div class="bar-track">
            <div id="bar-segments"></div>
            <div class="bar-tooltip" id="bar-tooltip"></div>
            <div class="majority-marker" id="majority-marker"></div>
            <div class="majority-text" id="majority-text"></div>
          </div>
        </div>

        <div class="pacto-summary" id="pacto-summary">
          Selecciona partidos para formar una mayoría.
        </div>

        <button type="button" class="reset-btn" id="reset-btn">
          Volver a empezar
        </button>

        <div class="pacto-parties-list" id="pacto-parties-list"></div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', function () {
      // ===== CONFIGURACIÓN SUPABASE =====
      const supabaseUrl = 'https://xllvmudwstmeqvpcbzhs.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsbHZtdWR3c3RtZXF2cGNiemhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2Nzc2NjEsImV4cCI6MjA4MDI1MzY2MX0.cxLTnkEYd8Vj34ISZcQvs_CdRjNE3x4eLl7t9NY_13A';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

      // ===== ESTADO DE LA APLICACIÓN =====
      const data = {
        totalSeats: 65,
        parties: [] // se rellenará desde Supabase
      };
      // Firma de los datos para detectar cambios
      let lastDataSignature = null;

      // ===== REFERENCIAS DOM =====
      const totalSeatsMaxEl      = document.getElementById('total-seats-max');
      const totalSeatsSelectedEl = document.getElementById('total-seats-selected');
      const majorityNumberEl     = document.getElementById('majority-number');
      const majorityMarkerEl     = document.getElementById('majority-marker');
      const majorityTextEl       = document.getElementById('majority-text');
      const pactoSummaryEl       = document.getElementById('pacto-summary');
      const partyTableBodyEl     = document.getElementById('party-table-body');
      const partyListEl          = document.getElementById('pacto-parties-list');
      const barSegmentsEl        = document.getElementById('bar-segments');
      const barTooltipEl         = document.getElementById('bar-tooltip');
      const resetBtnEl           = document.getElementById('reset-btn');
      const lastUpdateLabelEl    = document.getElementById('last-update-label');
      const refreshBtnEl         = document.getElementById('refresh-btn');

      if (!partyTableBodyEl || !partyListEl) {
        console.error('No se han encontrado los contenedores principales del pactómetro');
        return;
      }

      const majority = Math.floor(data.totalSeats / 2) + 1; // 33 para 65

      totalSeatsMaxEl.textContent  = data.totalSeats;
      majorityNumberEl.textContent = majority;

      const majorityPercent = (majority / data.totalSeats) * 100;
      if (majorityMarkerEl && majorityTextEl) {
        majorityMarkerEl.style.left = majorityPercent + '%';
        majorityTextEl.style.left   = majorityPercent + '%';
        majorityTextEl.textContent  = 'Mayoría: ' + majority;
      }

      // ===== UTILIDADES =====

      function getPartyColor(partyId, partyName) {
        const map = {
          pp:   '#0070c0',
          psoe: '#e31837',
          vox:  '#53a318',
          up:   '#8c2c8d'
          // añade aquí más partidos si los necesitas
        };
        const key = (partyId || partyName || '').toString().toLowerCase();
        if (map[key]) return map[key];
        return '#666666'; // color por defecto
      }

      function getSelectedPartyIds() {
        return Array.from(document.querySelectorAll('.party-checkbox:checked'))
          .map(chk => chk.getAttribute('data-party-id'));
      }

      function updateLastUpdateLabel(dateObj) {
        if (!lastUpdateLabelEl) return;

        if (!dateObj) {
          lastUpdateLabelEl.textContent = 'Última actualización: —';
          return;
        }

        const d = new Date(dateObj);
        const timeStr = d.toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        const dateStr = d.toLocaleDateString('es-ES');
        lastUpdateLabelEl.textContent = 'Última actualización: ' + dateStr + ' ' + timeStr;
      }

      // ===== CARGA DE DATOS DESDE SUPABASE =====

      async function loadDataFromSupabase(preserveSelection = true) {
        const previouslySelected = preserveSelection ? getSelectedPartyIds() : [];

        try {
          const { data: rows, error } = await supabase
            .from('pactometro_results')
            .select('party_id, party_name, seats_2023, seats_2025, vote_pct_2025')
            .order('seats_2025', { ascending: false });

          if (error) {
            console.error('Error obteniendo datos de Supabase:', error);
            return;
          }

          const parties = (rows || []).map(row => {
            const seats2023 = row.seats_2023 ?? 0;
            const seats2025 = row.seats_2025 ?? 0;
            const vote2025  = row.vote_pct_2025;

            return {
              id: row.party_id,
              name: row.party_name,
              color: getPartyColor(row.party_id, row.party_name),
              seats2023,
              seats2025,
              vote2025: typeof vote2025 === 'number' ? vote2025 : null,
              diffSeats: seats2025 - seats2023
            };
          });

          // Ordenar por escaños 2025 (desc)
          parties.sort((a, b) => b.seats2025 - a.seats2025);

          // Crear firma nueva de los datos relevantes
          const newSignature = JSON.stringify(
            parties.map(p => ({
              id: p.id,
              seats2023: p.seats2023,
              seats2025: p.seats2025,
              vote2025: p.vote2025
            }))
          );

          const hasChanged = newSignature !== lastDataSignature;
          lastDataSignature = newSignature;

          data.parties = parties;

          // Renderizamos siempre, pero solo cambiamos la hora si hay cambios
          renderTable();
          renderPartyList(previouslySelected);
          updateTotals();

          if (hasChanged) {
            updateLastUpdateLabel(new Date());
          }
        } catch (err) {
          console.error('Error de red con Supabase:', err);
        }
      }

      // ===== RENDER TABLA IZQUIERDA =====
      function renderTable() {
        partyTableBodyEl.innerHTML = '';

        // Solo partidos con al menos 1 escaño en 2025
        const partiesWithSeats = data.parties.filter(p => p.seats2025 >= 1);

        partiesWithSeats.forEach(p => {
          const row = document.createElement('tr');
          const diff =
            p.diffSeats > 0
              ? '▲ ' + p.diffSeats
              : p.diffSeats < 0
                ? '▼ ' + Math.abs(p.diffSeats)
                : '–';

          row.innerHTML = `
            <td>
              <div class="party-label" style="background:${p.color}">
                <span>${p.name}</span>
              </div>
            </td>
            <td>${p.seats2023}</td>
            <td>${p.seats2025}</td>
            <td>${diff}</td>
          `;
          partyTableBodyEl.appendChild(row);
        });
      }

      // ===== RENDER LISTA DE PARTIDOS (CHECKBOXES) =====
      function renderPartyList(preselectedIds = []) {
        partyListEl.innerHTML = '';

        // Solo partidos con al menos 1 escaño en 2025
        const selectableParties = data.parties.filter(p => p.seats2025 >= 1);

        selectableParties.forEach(p => {
          const isChecked = preselectedIds.includes(p.id);
          const item = document.createElement('div');
          item.className = 'party-item';
          item.innerHTML = `
            <div class="party-item-left">
              <input type="checkbox"
                     class="party-checkbox"
                     data-party-id="${p.id}"
                     ${isChecked ? 'checked' : ''}>
              <span style="width:10px;height:10px;border-radius:2px;background:${p.color};display:inline-block;"></span>
              <span>${p.name}</span>
            </div>
            <div>
              <span>${p.seats2025} escaños</span>
            </div>
          `;
          partyListEl.appendChild(item);
        });

        const checkboxes = document.querySelectorAll('.party-checkbox');
        checkboxes.forEach(chk => {
          chk.addEventListener('change', updateTotals);
        });
      }

      // ===== TOOLTIP BARRA =====
      function showTooltip(evt, party) {
        if (!barTooltipEl) return;
        const rect = barSegmentsEl.getBoundingClientRect();
        const x = evt.clientX - rect.left;

        barTooltipEl.style.left = x + 'px';
        barTooltipEl.style.top  = rect.height + 'px';

        let voteText = 'sin dato';
        if (typeof party.vote2025 === 'number') {
          voteText = party.vote2025.toFixed(1) + '%';
        }

        barTooltipEl.textContent = `${party.name} · ${voteText} · ${party.seats2025} escaños`;
        barTooltipEl.style.display = 'block';
      }

      function hideTooltip() {
        if (!barTooltipEl) return;
        barTooltipEl.style.display = 'none';
      }

      // ===== ACTUALIZAR TOTALES Y BARRA =====
      function updateTotals() {
        let total = 0;
        const selectedParties = [];

        document.querySelectorAll('.party-checkbox:checked').forEach(chk => {
          const id = chk.getAttribute('data-party-id');
          const party = data.parties.find(p => p.id === id);
          if (party) {
            total += party.seats2025;
            selectedParties.push(party);
          }
        });

        totalSeatsSelectedEl.textContent = total;
        barSegmentsEl.innerHTML = '';

        // Ordenamos seleccionados también de mayor a menor escaños 2025
        selectedParties.sort((a, b) => b.seats2025 - a.seats2025);

        let acumulado = 0;
        selectedParties.forEach(p => {
          const widthPercent = (p.seats2025 / data.totalSeats) * 100;
          const leftPercent  = (acumulado / data.totalSeats) * 100;

          const seg = document.createElement('div');
          seg.className = 'bar-segment';
          seg.style.left = leftPercent + '%';
          seg.style.width = widthPercent + '%';
          seg.style.background = p.color;

          seg.addEventListener('mousemove', evt => showTooltip(evt, p));
          seg.addEventListener('mouseenter', evt => showTooltip(evt, p));
          seg.addEventListener('mouseleave', hideTooltip);

          barSegmentsEl.appendChild(seg);
          acumulado += p.seats2025;
        });

        if (total === 0) {
          pactoSummaryEl.textContent = 'Selecciona partidos para formar una mayoría.';
        } else if (total >= majority) {
          pactoSummaryEl.textContent =
            '✅ Mayoría alcanzada (' + total + ' escaños) con: ' +
            selectedParties.map(p => p.name).join(', ') + '.';
        } else {
          const diff = majority - total;
          pactoSummaryEl.textContent =
            '❌ No hay mayoría (' + total + ' escaños). Faltan ' + diff + ' escaños.';
        }

        // Recalcular altura para el iframe después de cambios
        sendHeightToParent();
      }

      // ===== RESET =====
      function resetSelection() {
        document.querySelectorAll('.party-checkbox').forEach(chk => {
          chk.checked = false;
        });
        hideTooltip();
        updateTotals();
      }

      if (resetBtnEl) {
        resetBtnEl.addEventListener('click', resetSelection);
      }

      // ===== REFRESCO MANUAL =====
      async function handleRefreshClick() {
        if (!refreshBtnEl) return;
        const originalText = refreshBtnEl.textContent;
        refreshBtnEl.disabled = true;
        refreshBtnEl.textContent = 'Actualizando...';
        try {
          await loadDataFromSupabase(true);
        } finally {
          refreshBtnEl.disabled = false;
          refreshBtnEl.textContent = originalText;
        }
      }

      if (refreshBtnEl) {
        refreshBtnEl.addEventListener('click', handleRefreshClick);
      }

      // ===== COMUNICAR ALTURA AL PADRE (AUTO-RESIZE IFRAME) =====
      function sendHeightToParent() {
        const height = document.documentElement.scrollHeight;
        window.parent.postMessage(
          { type: 'pactometro-resize', height },
          '*'
        );
      }

      // ===== INICIO =====
      renderTable();
      renderPartyList();
      updateTotals();

      // Carga inicial desde Supabase y refresco automático cada 2 minutos (120000 ms)
      loadDataFromSupabase(false);
      setInterval(() => loadDataFromSupabase(true), 120000);

      window.addEventListener('load', sendHeightToParent);
      window.addEventListener('resize', () => {
        clearTimeout(window.__pactoResizeTimeout);
        window.__pactoResizeTimeout = setTimeout(sendHeightToParent, 150);
      });
    });
  </script>
</body>
</html>




